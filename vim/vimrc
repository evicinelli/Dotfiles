" Vim-plug {{{
call plug#begin()
Plug 'tpope/vim-sensible'                            " Sensible default
Plug '~/.fzf/'                                       " Fzf <3
Plug 'scrooloose/nerdtree',	{'on': 'NERDTreeToggle'} " Nerdtree
Plug 'chriskempson/base16-vim'                       " Colorscheme
Plug 'junegunn/goyo.vim', 	{'on': 'Goyo'}           " Goyo - distraction free writing
Plug 'airblade/vim-gitgutter'                        " Git diff aside line numbers
Plug 'mhinz/vim-startify'                            " Vim-startify
Plug 'tpope/vim-surround'                            " Surrounding motions on steroid
Plug 'sheerun/vim-polyglot'                          " A collection of language pack
Plug 'fretep/todo.txt-vim'                           " Todo.txt support
Plug 'majutsushi/tagbar',	{'on': 'Tagbar'}         " Tagbar
Plug 'mileszs/ack.vim'                               " Vim Ack
Plug 'godlygeek/tabular'                             " Tabularize
Plug 'junegunn/limelight.vim'                        " Focus only current paragraph
Plug 'vim-pandoc/vim-pandoc'                         " Pandoc integration
Plug 'vim-pandoc/vim-pandoc-syntax'
Plug 'vim-airline/vim-airline'                       " Statusline
Plug 'vim-airline/vim-airline-themes'                " Airline theme
call plug#end()
"}}}

" General Settings {{{
syntax enable             " Enable syntax Highlighting
filetype plugin on        " Filetype plugin
filetype plugin indent on " Specific indentation rules depending on file type
set number relativenumber " Line numbers are relative to current line
set path^=**              " Recursive file search starting from current dir
set wildmenu              " Tab autocompletion in menu
set wildignorecase        " Ignore case when autocomplete
set ignorecase            " Mah
set autoread              " Autoreload file if modified from external command
set hlsearch              " Highlight all search results
set smartcase             " Smart-case search
set incsearch             " Incremental search
set autoindent            " Auto-indent
set smartindent           " Smart indent
set tabstop=4             " show existing tab with 4 spaces width
set shiftwidth=4          " when indenting with '>', use 4 spaces width
set expandtab             " On pressing tab, insert 4 spaces
set foldmethod=syntax     " Fold according to syntax
set linebreak             " Break long lines at spaces, not in the middle of a word
set hidden                " Allow to switch buffer without saving it
set colorcolumn=+1        " Highlight column where the 81/th char lives
set shell=/bin/bash\ -i   " Which shell to use
set spelllang=it,en       " Spell dictionaries
set splitright            " vsplit on the right
set splitbelow            " split below
set mouse=a               " Enable mouse in terminal vim
set modeline              " Vim executes vimL commands if they are found in the current file
set noshowmode            " No mode indicator
set updatetime=1000       " Consider vim inactive after 1 sec of no activity
let mapleader = " "
let maplocalleader = " "
"}}}

" Appearance and gui settings {{{
set cursorline                                                " Highlight current line
set linespace=6                                               " Line spacing
set fillchars+=vert:\|                                        " Vertical separator char
set shortmess+=I                                              " No greetings
set list listchars=tab:·\ ,trail:·,eol:¬,extends:…,precedes:… " Non printable chars
set guifont=Monaco\ 11
set bg=light
" }}}

" Gvim vs terminal vim settings {{{
if has('gui_running')
    colorscheme base16-default-light
    let g:fzf_launcher = 'i3-sensible-terminal -geometry 120x30 -e bash -c %s' " Launcher for fzf
    set guioptions-=m                                         " remove menu bar
    set guioptions-=T                                         " remove toolbar
    set guioptions-=r                                         " remove right-hand scroll bar
    set guioptions-=L                                         " remove left-hand scroll bar
    set guioptions-=b
    set guioptions-=e
else
    colorscheme base16-default-dark                           " Doesn't really matter, chosen by base16-shell anyway
    let base16colorspace=256
    set bg=dark
    set t_Co=256                                              " 256 color vim
endif
" }}}

" Plugin settings {{{
let NERDTreeChDirMode = 0
let g:one_allow_italics = 1
let g:goyo_height = 50
let g:goyo_width = 130
let g:limelight_conceal_ctermfg = 'gray'
let g:limelight_conceal_guifg = 'DarkGray'
let g:scratch_insert_autohide = 0
let g:startify_change_to_dir = 0
let g:startify_change_to_vcs_root = 0
let g:startify_custom_header = [system("motivation")]
let g:pandoc#filetypes#handled = ["pandoc", "markdown", "textile"]
let g:pandoc#biblio#use_bibtool = 1
let g:pandoc#syntax#conceal#use = 0
let g:airline_symbols_ascii = 1
" let g:airline_symbols.maxlinenr = ''
" }}}

" Statusline {{{
" set statusline=%=%n\ \|\ %F\ %m%r%h%w\ \|\ %Y\ \|\ %l/%L:%v\ \|\ %p%%
" }}}

" Custom mappings and abbreviations {{{
inoremap " ""<Left>
inoremap ( ()<Left>
inoremap <C-Backspace> <C-w>
inoremap <F1> <Esc>
inoremap [ []<Left>
inoremap ` ``<Left>
inoremap { {}<Left>
noremap :Q :q
noremap :W :w
noremap :e :FZF<CR>
noremap Y y$
noremap Z zMzv
noremap vaz [zV]z
noremap viz [zjV]zk
noremap <C-g> :Goyo<CR>
noremap <C-h> h
noremap <C-j> j
noremap <C-k> k
noremap <C-l> l
noremap <C-n> :NERDTreeToggle<CR>
noremap <F1> :tabnew <CR>
noremap <leader>p :tabprevious <CR>
noremap <leader>n :tabNext <CR>
noremap <F8> :se spell!<CR>
noremap <F9> :se nowrap!<CR>
noremap <leader>a :Ack 
noremap <leader>t :Tags<CR>
noremap <leader>so :!xdg-open "%" <CR>
noremap <leader><leader> zA <CR>
cabbrev f find
" }}}

" Extended text Objects (thanks to Conner McDaniel) {{{
" They slow down quite a bit commands like cc, dd, yy..
" let s:items = [ "." , "-" , "_" , "*" , ":" , "/" , "<bar>"] 
" 
" for item in s:items
"     exe "noremap yi".item." T".item."dt".item
"     exe "noremap ya".item." T".item."dt".item
"     exe "noremap ci".item." T".item."dt".item
"     exe "noremap ca".item." T".item."dt".item
"     exe "noremap di".item." T".item."dt".item
"     exe "noremap da".item." T".item."dt".item
"     exe "vnoremap vi".item." T".item."dt"item
"     exe "vnoremap va".item." T".item."dt"item
" endfor
set matchpairs+=<:>
" }}}

" Autogroups and Autocmds {{{
augroup text
     au BufNewFile,BufRead,BufWrite *.txt,*.md,*.mkd,*.markdown,*.mdwn setl ft=pandoc
     au bufnewfile,bufread,bufwrite todo.txt setl ft=todo | set nospell
     au bufnewfile,bufread,bufwrite done.txt setl ft=todo | set nospell
augroup end
augroup nonvim
    au!
    au BufRead *.png,*.jpg,*.pdf,*.gif,*.scpt,*.doc,*.odt,*.ppt,*.odp,*.xls,*.ods,*.{mp3,mp4,mov,mkv} sil exe "!xdg-open " . shellescape(expand("%:p")) . " &" | bd | let &ft=&ft | redraw!
    au BufReadPost *.{docx,xlsx,pptx} sil exe "!libreoffice " . shellescape(expand("%:p")) . " &" | bd | let &ft=&ft | redraw!
augroup end
augroup pyFiles
    au BufNewFile,BufRead,BufWrite *.py noremap <leader>p :!python "%" &<CR>
augroup end
augroup todotxt
    au BufNewFile,BufRead,BufWrite *.todo.txt setl ft=todo | set nospell
    au BufNewFile,BufRead,BufWrite *.done.txt setl ft=todo | set nospell
augroup end
autocmd! User GoyoEnter Limelight
autocmd! User GoyoLeave Limelight!
autocmd CursorHold * silent! update " Autosave the buffer if on hold > updatetime ms (normal mode only)
" }}}

" Functions {{{
function! s:DiffWithSaved()
    let filetype=&ft
    diffthis
    vnew | r # | normal! 1Gdd
    diffthis
    exe "setlocal bt=nofile bh=wipe nobl noswf ro ft=" . filetype
endfunction
com! DiffSaved call s:DiffWithSaved()

function! s:buflist()
  redir => ls
  silent ls
  redir END
  return split(ls, '\n')
endfunction

function! s:bufopen(e)
  execute 'buffer' matchstr(a:e, '^[ 0-9]*')
endfunction

nnoremap <silent> :ls :call fzf#run({
\   'source':  reverse(<sid>buflist()),
\   'sink':    function('<sid>bufopen'),
\   'options': '+m --height=80%',
\   'down':    len(<sid>buflist())
\ })<CR>

" vim: fdm=marker
