"Vim-plug {{{
call plug#begin()
if !has("nvim")
    Plug 'tpope/vim-sensible'                                        " Sensible default
endif
Plug 'junegunn/fzf',	{ 'dir': '~/.fzf', 'do': './install --all' } " Fzf <3
                                                                     " Plug 'junegunn/fzf.vim',
Plug 'mhinz/vim-startify'                                            " Vim-startify
Plug 'tpope/vim-surround'                                            " Surrounding motions on steroid
Plug 'tpope/vim-fugitive'
Plug 'sheerun/vim-polyglot'                                          " A collection of language pack
Plug 'fretep/todo.txt-vim'                                           " Todo.txt support
Plug 'mileszs/ack.vim'                                               " Ack in vim
Plug 'godlygeek/tabular'                                             " Tabularize
Plug 'vim-pandoc/vim-pandoc'                                         " Pandoc integration
Plug 'vim-pandoc/vim-pandoc-syntax'                                  " Pandoc integration
Plug 'jeffkreeftmeijer/vim-dim'                                      " 16 color colorscheme
Plug 'paroxayte/autocd.vim'                                          " Autocd in folder rule-based
Plug 'SirVer/ultisnips'                                              " Snippets
Plug 'junegunn/goyo.vim'
call plug#end()
" }}}

" Options {{{
syntax enable             " Enable syntax Highighting
filetype plugin on        " Filetype plugin
filetype plugin indent on " Specific indentation rules depending on file type
set number relativenumber " Line numbers are relative to current line
set path^=**              " Recursive file search starting from current dir
set wildmenu              " Tab autocompletion in menu
set wildignorecase        " Ignore case when autocomplete
set ignorecase            " Mah
set autoread              " Auto reload file if modified from external command
set hlsearch              " Highlight all search results
set smartcase             " Smart-case search
set incsearch             " Incremental search
set autoindent            " Auto-indent
set smartindent           " Smart indent
set tabstop=4             " Show existing tab with 4 spaces width
set shiftwidth=4          " When indenting with '>', use 4 spaces width
set expandtab             " On pressing tab, insert 4 spaces
set foldmethod=syntax     " Fold according to syntax
set linebreak             " Break long lines at spaces, not in the middle of a word
set hidden                " Allow to switch buffer without saving it
set colorcolumn=+1        " Highlight column where the 81/th char lives
set spelllang=it,en       " Spell dictionaries
set spell
set splitright            " Vsplit on the right
set splitbelow            " Split below
set mouse=a               " Enable mouse in terminal vim
set modeline              " Vim executes vimL commands if they are found in the current file
set updatetime=2000       " Consider vim inactive after 4 sec of no activity in normal mode
set noautochdir
let mapleader = " "
let maplocalleader = " "
if has("nvim")
    set inccommand=nosplit
endif
"}}}

" Statusline {{{
set statusline=%t%=\ %m%r%h%w\ \/\ %Y\ \/\ %l,%v\ (%p%%\ di\ %L)
"\ \/\ %{strftime('%H:%M')}\ %{system('[[\ -e\ \/tmp\/gtd\ \]\]\ &&\ cat\ \/tmp\/gtd')}

" set showtabline=2
" let g:airline_symbols_ascii = 1
" let g:airline_section_z=' %l/%L:%v (%p%%)'
" set noshowmode
" }}}

" Appearance {{{
set list listchars=tab:·\ ,trail:·,eol:¬,extends:»,precedes:« " Non printable chars
if has('gui_running')
    let g:fzf_launcher = 'urxvt -geometry 120x30 -e bash -c %s' " Launcher for fzf
    set guioptions-=m                                         " remove menu bar
    set guioptions-=T                                         " remove toolbar
    set guioptions-=r                                         " remove right-hand scroll bar
    set guioptions-=L                                         " remove left-hand scroll bar
    set guioptions-=b
    set guioptions-=e
    set linespace=6                                               " Line spacing
endif
colorscheme dim
set shortmess+=I                                              " No greetings
set fillchars=vert:\|,fold:-
set cursorline
set guifont=Iosevka\ 13

"highlight clear StatusLine
highlight clear FoldColumn|hi FoldColumn ctermfg=0
highlight StatusLine   ctermfg=7    ctermbg=8
highlight StatusLineNC   ctermfg=11    ctermbg=0
"highlight VertSplit   ctermfg=7    ctermbg=0
"highlight LineNr ctermfg=11 ctermbg=0
highlight clear CursorLine
highlight CursorLine ctermbg=8
highlight ColorColumn ctermbg=9 ctermfg=15
highlight SpellBad ctermbg=none ctermfg=9
highlight SpellCap ctermbg=none ctermfg=14
highlight Folded ctermbg=8 ctermfg=7
"highlight FoldColumn ctermbg=0 ctermfg=3
highlight TodoDueToday ctermbg=3 ctermfg=0
highlight PmenuSel ctermbg=4
" }}}

" Plugin settings {{{
let g:UltiSnipsNoPythonWarning = 1

let g:netrw_banner = 0          " no banner
let g:netwr_browse_split = 4    " open in prior window
let g:netwr_altv = 1            " split to the right
let g:netrw_liststyle = 0       " tree view
let g:netwr_list_hide = netrw_gitignore#Hide()

let g:limelight_conceal_ctermfg = 'gray'
let g:limelight_conceal_guifg = 'DarkGray'

let g:startify_change_to_dir = 0
let g:startify_change_to_vcs_root = 0
let g:startify_custom_header = [""]

let g:pandoc#filetypes#handled = ["pandoc", "markdown", "textile", "extra"]
let g:pandoc#biblio#use_bibtool = 1
let g:pandoc#syntax#conceal#use = 0
" let g:pandoc#modules#disabled = ["folding"]
" let g:pandoc#syntax#conceal#blacklist = ['titleblock', 'list', 'dashes', 'image', 'atx', 'codeblock_start', 'quotes']
let g:pandoc#toc#close_after_navigating = 0

let g:fzf_action = {
    \ 'ctrl-t': 'tab split',
    \ 'ctrl-h': 'split',
    \ 'ctrl-v': 'vsplit' }

let g:autocd#autocmd_enable = 1
let g:autocd#markers = { '**/Medicina/**/*.md': ['Makefile'] }

" }}}

" Mappings {{{
inoremap " ""<Left>
inoremap ( ()<Left>
inoremap <C-c> <C-o>:noh<CR>
inoremap <C-p> <Esc>:FZF<CR>
inoremap <C-z> <C-o><C-z>
inoremap <F1> <Esc>
inoremap [ []<Left>
inoremap ` ``<Left>
inoremap { {}<Left>
noremap <Backspace> k
noremap <CR> j
noremap <F1> <Esc>
noremap <leader>nn :set number relativenumber <CR>
noremap <leader>nnr :set nonumber norelativenumber <CR>
noremap :Q :q
noremap :W :w
noremap / mc/
noremap <C-h> h
noremap <C-j> j
noremap <C-k> k
noremap <C-l> l
noremap <C-c> :noh<CR>
noremap <C-n> :cn<CR>
noremap <C-p> :FZF --no-exact<CR>
noremap <F8> :se spell!<CR>
noremap <F9> :se nowrap!<CR>
noremap <leader><leader> zA <CR>
noremap <leader>a :Ack -i 
noremap <leader>f :FZF --no-exact 
noremap <leader>fd :FZF --no-exact $DBX<CR>
noremap <leader>fh :FZF --no-exact ~<CR>
noremap <leader>fm :FZF --no-exact $MED<CR>
noremap <leader>fo :FZF --no-exact $OC<CR>
noremap <leader>p :FZF --no-exact<CR>
noremap <leader>so :!xdg-open "%" <CR>
noremap Y y$
noremap Z zMzv
noremap vaz [zV]z
noremap viz [zjV]zk
vnoremap J j
vnoremap K k
if has("nvim")
     tnoremap <C-\> <C-\><C-n>
endif
" }}}

" Abbreviations {{{
cabbrev f find
iabbrev perchè perché
iabbrev Perchè Perché
 " }}}

" Extended text Objects (Conner McDaniel) and matchpairs {{{
let s:items = [ ",", "." , "-" , "_" , "*" , ":" , "/" , "<bar>", "+", "\\"]
for item in s:items
    exe "noremap yi".item." T".item."yt".item
    exe "noremap ya".item." F".item."yf".item
    exe "noremap ci".item." T".item."ct".item
    exe "noremap ca".item." F".item."cf".item
    exe "noremap di".item." T".item."dt".item
    exe "noremap da".item." F".item."df".item
    exe "vnoremap vi".item." T".item."vt"item
    exe "vnoremap va".item." F".item."vf"item
endfor

set matchpairs+=<:>
" }}}

 " Autogroups and Autocmds {{{
augroup text
     au BufNewFile,BufRead,BufWrite *.txt,*.md,*.mkd,*.markdown,*.mdwn setl ft=pandoc
     au bufnewfile,bufread,bufwrite todo.txt setl ft=todo | set nospell
     au bufnewfile,bufread,bufwrite done.txt setl ft=todo | set nospell
augroup end

augroup nonvim
    au!
    au BufRead *.png,*.jpg,*.pdf,*.gif,*.scpt,*.doc,*.odt,*.ppt,*.odp,*.xls,*.ods,*.{mp3,mp4,mov,mkv} sil exe "!xdg-open " . shellescape(expand("%:p")) . " &" | bd | let &ft=&ft | redraw!
    au BufReadPost *.{docx,xlsx,pptx} sil exe "!libreoffice " . shellescape(expand("%:p")) . " &" | bd | let &ft=&ft | redraw!
augroup end

augroup pyFiles
    au BufNewFile,BufRead,BufWrite *.py noremap <leader>p :!python "%" &<CR>
augroup end

augroup todotxt
    au BufNewFile,BufRead,BufWrite *.todo.txt setl ft=todo | set nospell
    au BufNewFile,BufRead,BufWrite *.done.txt setl ft=todo | set nospell
augroup end

autocmd CursorHold * silent! update " Autosave the buffer if on hold > updatetime ms (normal mode only)

autocmd! BufWritePost *vimrc* source %

au BufNewFile,BufRead *.md
    \ nnoremap <leader><leader> /<++><CR>cf>|
    \ inoremap <C-j> ![<++>](img/<++>)|
    \ inoremap ^ ^^<Left>|
    \ inoremap ~ ~~<Left>|

" }}}

" Functions {{{
function! FileViewer()
    set nosplitright
    vsplit .
    normal 30< 
    set splitright
endfunction

function! s:DiffWithSaved()
    let filetype=&ft
    diffthis
    vnew | r # | normal! 1Gdd
    diffthis
    exe "setlocal bt=nofile bh=wipe nobl noswf ro ft=" . filetype
endfunction
com! DiffSaved call s:DiffWithSaved()

function! s:buflist()
  redir => ls
  silent ls
  redir END
  return split(ls, '\n')
endfunction
" }}}

" Notes {{{
command! -nargs=1 Nack vimgrep "<args>" $MED/**/*.md
nnoremap <leader>n :Nack 
" }}}

" vim: fdm=marker
